<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
    <title>Getourguide</title>
    <link rel="stylesheet" type="text/css" href="../Content/css/itinerary/humanity/jquery-ui-1.10.0.custom.css" />
    <script src="../Scripts/itinerary/jquery-1.8.2.js"></script>
    <script src="../Scripts/itinerary/jquery-ui.js"></script>
    <link rel="shortcut icon" href="https://a2.muscache.com/airbnb/static/logotype_favicon-6ba9bbe6f8ca077e990ca287d87b10b5.ico">
    
    <link rel="stylesheet" type="text/css" href="../Content/css/itinerary/fullcalendar.css">
    <link rel="stylesheet" type="text/css" href="../Content/css/itinerary/fullcalendar.print.css" media="print">
    <script type="text/javascript" src="../Scripts/itinerary/fullcalendar.min.js"></script>
	<script type="text/javascript" src="../Scripts/itinerary/jquery.isotope.js"></script>
	<script type="text/javascript" src="../Scripts/index/metrojs.js"></script>
    <link rel="stylesheet" type="text/css" href="../Content/css/itinerary/metrojs.css"/>
    <link rel="stylesheet" type="text/css" href="../Content/css/itinerary/style2.css"/>
	
    <style>
	    #_gdir{font-size:14px;}
        #_gdir > div{font-weight:bold;text-align:center;}
        #_gdir p._sum{text-align:center;font-weight:bold;color:#3a741f;}
        #_gdir ol{padding:10px 30px 10px 40px;}
        #_gdir ol li{border-bottom:1px solid #ccc;}
        #_gdir ol li div p.r{font-size:11px;color:#3a741f;text-align:right;}
        #_gdir div._copy{font-size:12px;font-weight:normal;}

    </style>
	<script type="text/javascript" src="http://gothere.sg/jsapi?sensor=false"></script>
    <script>
    	var curdate = new Date()
		var TODAY = new Date()
		gothere.load("maps");
        gothere.setOnLoadCallback(initialize);
        var directions;
        function initialize() {
            //$("#map_container").hide();
            if (GBrowserIsCompatible()) {
                // Create the Gothere map object.
            	var map = new GMap2(document.getElementById("map"));
            	// Set the center of the map.
            	map.setCenter(new GLatLng(1.362083, 103.819836), 11);
            	// Add zoom controls on the top left of the map.
            	map.addControl(new GSmallMapControl());
            	// Add a scale bar at the bottom left of the map.
            	map.addControl(new GScaleControl());
            	
            	directions = new GDirections(map, document.getElementById("panel"));
                //directions.load("from: Changi Airport to: Orchard Road", {travelMode: G_TRAVEL_MODE_TRANSIT});
                
              }
        }
        
        /*function getDirections(from, to, mode) {
            var travelMode;
            switch(mode) {
                case "pt":
                    travelMode = G_TRAVEL_MODE_TRANSIT;
                    break;
                case "t":
                    travelMode = G_TRAVEL_MODE_TAXI;
                    break;
                case "d":
                default:
                    travelMode = G_TRAVEL_MODE_DRIVING;
                    break;
            }
            directions.load("from: " + from + " to: " + to, {travelMode: travelMode});
        }*/

		function addMinutes(date, minutes) {
		    return new Date(date.getTime() + minutes*60000);
		}

		function getSmallestStartDate(arrayDate, id_toignore) {
			d = new Date();
			d.setHours(23);
			d.setMinutes(59);
			m = {start : d};
			$.each(arrayDate, function(i,item){
				if(item.start <= m.start && item.id != id_toignore)
					m = item;
			});
			if(m.id == null) return null;
		    else return m;
		}

		function getBiggestEndDate(arrayDate, id_toignore) {
			d = new Date();
			d.setHours(0);
			d.setMinutes(0);
			m = {end : d}
			$.each(arrayDate,function(i,item){
				if(item.end >= m.end && item.id != id_toignore)
					m = item;
			});
			if(m.id == null) return null; 
		    else return m;
		}

		function getNextEvent(arrayEvent, event) {
			d = new Date();
			d.setHours(23);
			d.setMinutes(59);
			m = {start : d}
			$.each(arrayEvent,function(i,item){
				if(item.start > event.start && item.start <= m.start && event.id != item.id){
					m = item;
				}
			});
			if(m.id == null) { return null;  }
		    else return m;
		}
		
		function getNextEventNotTravel(arrayEvent, event) {
			d = new Date();
			d.setHours(23);
			d.setMinutes(59);
			m = {start : d}
			$.each(arrayEvent,function(i,item){
				console.log('check is before: ' + event.start + ' < ' + item.start);
				if(item.start > event.start && item.start <= m.start && !isTravelEvent(item) && event.id != item.id)
					m = item;
			});
			if(m.id == null) { return null;  }
		    else return m;
		}
		
		function getPreviousEvent(arrayEvent, event) {
			d = new Date();
			d.setHours(0);
			d.setMinutes(0);
			m = {start : d}
			$.each(arrayEvent,function(i,item){
				if(item.start < event.start && item.start >= m.start && event.id != item.id)
					m = item;
			});
			if(m.id == null) { return null;  }
		    else return m;
		}
		
		function getPreviousEventNotTravel(arrayEvent, event) {
			d = new Date();
			d.setHours(0);
			d.setMinutes(0);
			m = {start : d}
			$.each(arrayEvent,function(i,item){
				if(item.start < event.start && item.start >= m.start && !isTravelEvent(item) && event.id != item.id)
					m = item;
			});
			if(m.id == null) { return null;  }
		    else return m;
		}

		function unOverlap(arrayEvent, event){
			ret = $.extend({}, event);
			$.each(arrayEvent,function(i,item){
				if(item.id != event.id){
		            if(!(item.start >= event.end || item.end <= event.start)){
		                if(item.start < event.end && item.end > event.end){
		                	console.log('geser atas')
		                	gap_minute = (event.end.getTime() - item.start.getTime()) / 60000;
						    event.end = addMinutes(event.end, -1*gap_minute )
						    event.start = addMinutes(event.start, -1*gap_minute )			
		                } else if(item.end > event.start && item.start < event.end){
		                	console.log('geser bawah')
		                	gap_minute = (item.end.getTime() - event.start.getTime()) / 60000;
						    event.end = addMinutes(event.end, gap_minute )
						    event.start = addMinutes(event.start, gap_minute )
		                }
		                return false;
		            }
		        }
			});
			return event;
		}
		
		function getEventOverlap(arrayEvent, event){
			m = null;
			$.each(arrayEvent,function(i,item){
				if(item.id != event.id){
		            if(!(item.start >= event.end || item.end <= event.start)){
		                m = item;
		                return false;
		            }
		        }
			});
			return m;
		}

		function isEventOverlap(arrayEvent, event){
			ret = false;
			$.each(arrayEvent,function(i,item){
				if(item.id != event.id){
		            if(!(item.start >= event.end || item.end <= event.start)){
		                ret = true;
		                return false;
		            }
		        }
			});
			return ret;
		}

		function isTwoEventOverlap(event1, event2){
			ret = false;
		    if(!(event1.start >= event2.end || event1.end <= event2.start)){
                ret = true;
            }
		    return ret;
		}
		
		function isEventPossibleToUnOverlap(arrayEvent, event){
			e = $.extend({}, event);
			e = unOverlap(arrayEvent, e);
			if(isEventOverlap(arrayEvent, e) || e.start.getHours() < 6 || e.end.getDate() != curdate.getDate()){
				console.log('cant unOverlap')
				return false;
			}
			return true;
		}

		function isEventExist(arrayEvent, event) {
			ret = false;
			$.each(arrayEvent,function(i,item){
				if(item.id == event.id){
					ret = true;
					return false;
				}
			});
			return ret;
		}
		
		function isTravelEvent(event) {
			return (event.type == 'travel');
		}

		function getTimestamp(){
			d = new Date();
			return d.getTime();
		}
		
		$(function() {
			$("#cover").show();
			$("#cover").click(function(){
				$("#cover").hide();
			});


			$('#catalog .live-tile').each(function() {
			
				// create an Event Object (http://arshaw.com/fullcalendar/docs/event_data/Event_Object/)
				// it doesn't need to have a start or end
				var eventObject = {
					title: $.trim($(this).attr("title")), // use the element's text as the event title
					id: $(this).attr("event_id"),
					event_id: $(this).attr("event_id"),
					duration: parseInt($(this).attr("activity_duration")),
					allDay: false,
					type: 'venue',
		            editable: true
				};
				
				// store the Event Object in the DOM element so we can get to it later
				$(this).data('eventObject', eventObject);
				
				$(this).tooltip({
					content: $.trim($(this).attr("title")) + "<br/>Drag me to Itinerary...",
				    position: {
				        my: "center bottom-20",
				        at: "center top",
				        using: function( position, feedback ) {
				          $( this ).css( position );
				          $( "<div>" )
				            .addClass( "arrow" )
				            .addClass( feedback.vertical )
				            .addClass( feedback.horizontal )
				            .appendTo( this );
				        }
				    }
			    });

			    $(this).click(function(e) {
			    	$("#venue_container").slideDown('slow');
			    });

			   	// make the event draggable using jQuery UI
				$(this).draggable({

					appendTo: "body",
					helper: function(event) {
						j = jQuery($(this));
						drag = j.find("img").clone().css('width','120px');
						drag.css('height','120px');
	                    
	                    return drag;
	                },
					scroll: true,
					zIndex: 990,
					revert: true,      // will cause the event to go back to its
					revertDuration: 0,  //  original position after the drag
					cursor: "move", 
					cursorAt: { top: 55, left: 55 },
					// once the dragging starts, we decrease the opactiy of other items
					// Appending a class as we do that with CSS
					start:function (event, ui) {
						$(this).addClass("active");
						$(this).closest("#catalog").addClass("active");
					},
					// removing the CSS classes once dragging is over.
					stop:function (event, ui) {
						$(this).removeClass("active").closest("#catalog").removeClass("active");
					}
			        
				});
				
			});


			$("body").click(function(e) {
		        if (e.target.id == "map_container" || $(e.target).parents("#calendar").size() || $(e.target).parents("#map_container").size()) { 
		            ;
		        } else if (e.target.id == "venue_container" || $(e.target).parents("#venue_container").size()){
		        	;
		        } else if ($(e.target).parents("#venue").size()){
		        	;
		        } else {
		        	$("#venue_container:visible").slideUp();
		           	$("#map_container:visible").fadeOut();
		        }
		    });
			
			$(".live-tile").liveTile({pauseOnHover: true});
			
			$('#calendar').fullCalendar({
				header: {
					left: 'title',
					center: '',
					right: 'prev,next'
				},
				allDaySlot: false,
				height: 600,
				defaultView: 'agendaDay',
				editable: true,
				minTime:6,
				maxTime:24,
				slotMinutes: 30,
				events: [],
				theme: true,
				selectHelper: true,
				droppable: true, // this allows things to be dropped onto the calendar !!!
				eventAfterRender: function(event, element) {
					element.tooltip({
						content: (event.type == 'travel')?'Travel time':'One click venue to get details. and Double click to remove from your itinerary!',
					    position: {
					        my: "center bottom-20",
					        at: "center top",
					        using: function( position, feedback ) {
					          $( this ).css( position );
					          $( "<div>" )
					            .addClass( "arrow" )
					            .addClass( feedback.vertical )
					            .addClass( feedback.horizontal )
					            .appendTo( this );
					        }
					    }
				    }),
					element.bind('dblclick', function() {
				        console.log(event);
				        if(event.type == 'travel')
				        	return false;

						//remove event reconstruct travel event
						$( window ).attr('title','Are you sure to delete <br/>\'' + event.title + '\'?').dialog({
						    resizable: false,
						    height:140,
						    modal: true,
				            buttons: {
				                'Yes, Delete please': function() {
				                    events_search = $('#calendar').fullCalendar('clientEvents',function(event_s) {
							                return event_s.start.getDate() == curdate.getDate();
							            });
							        original_event = $.extend({}, event);
								    ori_prev_event_t = getPreviousEvent(events_search, original_event);
									ori_next_event_t = getNextEvent(events_search, original_event);
									console.log('bazinga')
									del_bef = false; del_af = false;
									if(ori_prev_event_t != null && isTravelEvent(ori_prev_event_t)){
										console.log('removing travel before:' + ori_prev_event_t.id)
										del_bef = true;
										$('#calendar').fullCalendar('removeEvents',ori_prev_event_t.id);
										events_search = $('#calendar').fullCalendar('clientEvents',function(event_s) {
							                return event_s.start.getDate() == curdate.getDate();
							            });
								    }
								    if(ori_next_event_t != null && isTravelEvent(ori_next_event_t)){
										console.log('removing travel after:' + ori_next_event_t.id)
										del_af = true;
										$('#calendar').fullCalendar('removeEvents',ori_next_event_t.id);

										events_search = $('#calendar').fullCalendar('clientEvents',function(event_s) {
							                return event_s.start.getDate() == curdate.getDate();
							            });
								    }

								    if(del_af || del_bef){
								    	ori_prev_event = getPreviousEventNotTravel(events_search, original_event);
										prev_event = getPreviousEventNotTravel(events_search, event);
										ori_next_event = getNextEventNotTravel(events_search, original_event);
										next_event = getNextEventNotTravel(events_search, event);
										if(prev_event == null) next_event = {id: "dummy"}
										if(next_event == null) next_event = {id: "dummy"}
										if(ori_prev_event != null && ori_next_event != null && next_event.id != ori_next_event.id && prev_event.id != ori_prev_event.id){
											from = ori_prev_event.title;
								    		to = ori_next_event.title;
								    		gmaps_url = "http://maps.googleapis.com/maps/api/directions/json?origin="+encodeURIComponent(from)+",Singapore&destination="+encodeURIComponent(to)+",Singapore&sensor=false&mode=transit&departure_time="+Math.floor(new Date().getTime()/1000);
											$.getJSON(gmaps_url,
											  	function(data) {
												    if(data.routes.length > 0){
													    duration = Math.floor( parseInt(data.routes[0].legs[0].duration.value) / 60);
													    duration_text = data.routes[0].legs[0].duration.text;
													}else{
														duration = 30
														duration_text = "Can't get estimated time"
													}
												    
												    event_travel = {
								                            id : getTimestamp() + "_transport",
								                            title : "Travel ["+duration_text+"]. Click for details!",
								                            start : ori_prev_event.end,
								                            end   : addMinutes(ori_prev_event.end, duration),
								                            type: 'travel',
								                            duration: duration,
						                            		allDay: false,
								                            editable: false,
								                            color: "#000000"
								                        }
												    
										    		$('#calendar').fullCalendar( 'renderEvent', event_travel, true );
										    		events_search = $('#calendar').fullCalendar('clientEvents',function(event_s) {
										                return event_s.start.getDate() == curdate.getDate();
										            });
											});
										}
								    }

							        $('#calendar').fullCalendar( 'removeEvents', event.id );

				                    $(this).dialog('close');
				                },
				                Cancel: function() {
				                    $(this).dialog('close');
				                }
				            }
				        });
				    });
				},
				drop: function(date, allDay) { // this function is called when something is dropped
			
					// retrieve the dropped element's stored Event Object
					var originalEventObject = $(this).data('eventObject');
					// we need to copy it, so that multiple events don't have a reference to the same object
					var copiedEventObject = $.extend({}, originalEventObject);
					
					// assign it the date that was reported
					copiedEventObject.start = date;
					copiedEventObject.id = curdate.getTime() + '_' + copiedEventObject.id;
					copiedEventObject.end = addMinutes(date, copiedEventObject.duration)
					copiedEventObject.allDay = allDay;
					
					sameDayEvents = $('#calendar').fullCalendar('clientEvents', function(event_s) {
			                return (event_s.start.getDate() == curdate.getDate());
			            });
					//not yet exist, not overlapped AND estimated finish still in the same day
					if( !isEventExist(sameDayEvents, copiedEventObject) && copiedEventObject.end.getDay() == curdate.getDay()) {
		  				if(!isEventPossibleToUnOverlap(sameDayEvents, copiedEventObject)){
					    	console.log('not possible to unoverlap')
					    } else{
						    if(sameDayEvents.length != 0){
							    if(isEventOverlap(sameDayEvents, copiedEventObject)){
							    	copiedEventObject = unOverlap(sameDayEvents, copiedEventObject);
							    }
								


							    put_prev_event = getPreviousEvent(sameDayEvents, copiedEventObject);
								put_next_event = getNextEvent(sameDayEvents, copiedEventObject);
								if(put_prev_event != null && isTravelEvent(put_prev_event)){
									$('#calendar').fullCalendar('removeEvents',put_prev_event.id);
									sameDayEvents = $('#calendar').fullCalendar('clientEvents',function(event_s) {
						                return event_s.start.getDate() == curdate.getDate();
						            });
							    }
							    if(put_next_event != null && isTravelEvent(put_next_event)){
									$('#calendar').fullCalendar('removeEvents',put_next_event.id);
									sameDayEvents = $('#calendar').fullCalendar('clientEvents',function(event_s) {
						                return event_s.start.getDate() == curdate.getDate();
						            });
							    }





								e_before = getPreviousEventNotTravel(sameDayEvents, copiedEventObject)
								if(e_before != null) {
									//there's event before
									console.log('calculating travel event before:' + e_before.id)
									from = e_before.title;
									to = copiedEventObject.title;
									event_t_before = {
			                            id : getTimestamp() + "_transport",
			                            title : "Travel [XXX]. Calculating travel time...",
			                            start : e_before.end,
			                            end   : addMinutes(e_before.end, 30),
			                            allDay: false,
			                            type: 'travel',
			                            editable: false,
			                            color: "#000000"
			                        }
							    
			                        $('#calendar').fullCalendar( 'renderEvent', event_t_before, true );

									gmaps_url = "http://maps.googleapis.com/maps/api/directions/json?origin="+encodeURIComponent(from)+",Singapore&destination="+encodeURIComponent(to)+",Singapore&sensor=false&mode=transit&departure_time="+Math.floor(new Date().getTime()/1000);
								   	console.log('google map:' + gmaps_url)
								   	$.getJSON(gmaps_url,
									  	function(data) {
									  		if(data.routes.length > 0){
											    duration_g = Math.floor( parseInt(data.routes[0].legs[0].duration.value) / 60);
											    duration_g_text = data.routes[0].legs[0].duration.text;
											}else{
												duration_g = 30
												duration_g_text = "Can't get estimated time"
											}
										    event_t_before.end = addMinutes(e_before.end, duration_g);
										   	event_t_before.title = "Travel [" +duration_g_text+ "]. Click for details!"
							                            
										    $('#calendar').fullCalendar( 'updateEvent', event_t_before );

										    if(isTwoEventOverlap(event_t_before, copiedEventObject)){
												copiedEventObject.start = addMinutes(e_before.end, duration_g);
							    				copiedEventObject.end = addMinutes(e_before.end, duration_g + copiedEventObject.duration)
							    				$('#calendar').fullCalendar('updateEvent', copiedEventObject);
							    			}
									});
								}
								
								e_after = getNextEventNotTravel(sameDayEvents, copiedEventObject)
								if(e_after != null) {
									//there's event after
									console.log('calculating travel event after:' + e_after.id)
									from = copiedEventObject.title;
									to = e_after.title;
									event_t_after = {
			                            id : getTimestamp() + "_transport",
			                            title : "Travel [XXX]. Calculating travel time...",
		                            	start : addMinutes(e_after.start, -1 * 30),
			                            end   : e_after.start,
			                            allDay: false,
			                            type: 'travel',
			                            editable: false,
			                            color: "#000000"
			                        }
								    $('#calendar').fullCalendar( 'renderEvent', event_t_after, true );
									gmaps_url = "http://maps.googleapis.com/maps/api/directions/json?origin="+encodeURIComponent(from)+",Singapore&destination="+encodeURIComponent(to)+",Singapore&sensor=false&mode=transit&departure_time="+Math.floor(new Date().getTime()/1000);
								   	$.getJSON(gmaps_url,
									  	function(data) {
										    if(data.routes.length > 0){
											    duration_g = Math.floor( parseInt(data.routes[0].legs[0].duration.value) / 60);
											    duration_g_text = data.routes[0].legs[0].duration.text;
											}else{
												duration_g = 30
												duration_g_text = "Can't get estimated time"
											}
										    event_t_after.start = addMinutes(e_after.start, -1 * duration_g);
									   		event_t_after.title = "Travel [" +duration_g_text+ "]. Click for details!"
						                	$('#calendar').fullCalendar( 'updateEvent', event_t_after );

										    if(isTwoEventOverlap(event_t_after, copiedEventObject)){
											    copiedEventObject.start = addMinutes(e_after.start, -1 * (duration_g + copiedEventObject.duration));
								    			copiedEventObject.end = addMinutes(e_after.start, -1 * duration_g)
								    			$('#calendar').fullCalendar('updateEvent', copiedEventObject);
								    		}
									});
								} 
								
							} 

							$('#calendar').fullCalendar('renderEvent', copiedEventObject, true);
						}
					}
					
				},
				eventMouseover: function( event, jsEvent, view ) { 
					$("#calendar").attr("title", event.title);
				},
				eventDrop: function(event,dayDelta,minuteDelta,allDay,revertFunc) {
					//two events can't overlap
				    var events_search = $('#calendar').fullCalendar('clientEvents',function(event_s) {
				                return event_s.start.getDate() == curdate.getDate();
				            });
				    ok=true
				    if(event.start.getHours() < 6 || event.end.getDay() != curdate.getDay()){
				    	ok=false;
				    	revertFunc();
				    } 
				    if(!isEventPossibleToUnOverlap(events_search, event)){
				    	console.log('not possible to unoverlap')
				    	revertFunc();
				    	ok=false;
				    }
				    
				    //not overlap and there's other event / not only this event
				    if(ok && events_search.length != 1){
				    	original_event = $.extend({}, event);
					    original_event.start = addMinutes(original_event.start, -1 * minuteDelta);
						original_event.end = addMinutes(original_event.end, -1 * minuteDelta);
						ori_prev_event_t = getPreviousEvent(events_search, original_event);
						ori_next_event_t = getNextEvent(events_search, original_event);
						console.log('bazinga')
						del_bef = false; del_af = false;
						if(ori_prev_event_t != null && isTravelEvent(ori_prev_event_t)){
							console.log('removing travel before:' + ori_prev_event_t.id)
							del_bef = true;
							$('#calendar').fullCalendar('removeEvents',ori_prev_event_t.id);
							events_search = $('#calendar').fullCalendar('clientEvents',function(event_s) {
				                return event_s.start.getDate() == curdate.getDate();
				            });
					    }
					    if(ori_next_event_t != null && isTravelEvent(ori_next_event_t)){
							console.log('removing travel after:' + ori_next_event_t.id)
							del_af = true;
							$('#calendar').fullCalendar('removeEvents',ori_next_event_t.id);

							events_search = $('#calendar').fullCalendar('clientEvents',function(event_s) {
				                return event_s.start.getDate() == curdate.getDate();
				            });
					    }

					    if(del_af || del_bef){
					    	ori_prev_event = getPreviousEventNotTravel(events_search, original_event);
							prev_event = getPreviousEventNotTravel(events_search, event);
							ori_next_event = getNextEventNotTravel(events_search, original_event);
							next_event = getNextEventNotTravel(events_search, event);
							if(prev_event == null) next_event = {id: "dummy"}
							if(next_event == null) next_event = {id: "dummy"}
							if(ori_prev_event != null && ori_next_event != null && next_event.id != ori_next_event.id && prev_event.id != ori_prev_event.id){
								from = ori_prev_event.title;
					    		to = ori_next_event.title;
					    		gmaps_url = "http://maps.googleapis.com/maps/api/directions/json?origin="+encodeURIComponent(from)+",Singapore&destination="+encodeURIComponent(to)+",Singapore&sensor=false&mode=transit&departure_time="+Math.floor(new Date().getTime()/1000);
								$.getJSON(gmaps_url,
								  	function(data) {
									    if(data.routes.length > 0){
										    duration = Math.floor( parseInt(data.routes[0].legs[0].duration.value) / 60);
										    duration_text = data.routes[0].legs[0].duration.text;
										}else{
											duration = 30
											duration_text = "Can't get estimated time"
										}
									    
									    event_travel = {
					                            id : getTimestamp() + "_transport",
					                            title : "Travel ["+duration_text+"]. Click for details!",
					                            start : ori_prev_event.end,
					                            end   : addMinutes(ori_prev_event.end, duration),
					                            type: 'travel',
					                            duration: duration,
			                            		allDay: false,
					                            editable: false,
					                            color: "#000000"
					                        }
									    
							    		$('#calendar').fullCalendar( 'renderEvent', event_travel, true );
							    		events_search = $('#calendar').fullCalendar('clientEvents',function(event_s) {
							                return event_s.start.getDate() == curdate.getDate();
							            });
								});
							}
					    }

				    	event = unOverlap(events_search, event);
					    
					    //first case: handle the event before this event
					    e_before = getPreviousEvent(events_search, event);
					    
					    e_t_b = "dummy"; 
					    if(e_before != null){
				    		if(isTravelEvent(e_before)){
				    			$('#calendar').fullCalendar('removeEvents',e_before.id);
				    			e_before = getPreviousEventNotTravel(events_search, event);
				    			events_search = $('#calendar').fullCalendar('clientEvents',function(event_s) {
					                return event_s.start.getDate() == curdate.getDate();
					            });
				    		}
				    		from = e_before.title;
				    		to = event.title;
			    			gmaps_url = "http://maps.googleapis.com/maps/api/directions/json?origin="+encodeURIComponent(from)+",Singapore&destination="+encodeURIComponent(to)+",Singapore&sensor=false&mode=transit&departure_time="+Math.floor(new Date().getTime()/1000);
							$.getJSON(gmaps_url,
							  	function(data) {
								    if(data.routes.length > 0){
									    duration = Math.floor( parseInt(data.routes[0].legs[0].duration.value) / 60);
									    duration_text = data.routes[0].legs[0].duration.text;
									}else{
										duration = 30
										duration_text = "Can't get estimated time"
									}
								    start_date_t = addMinutes(event.start, -1 * duration);
								    event_travel = {
				                            id : getTimestamp() + "_transport",
				                            title : "Travel ["+duration_text+"]. Click for details!",
				                            start : start_date_t,
				                            end   : event.start,
				                            type: 'travel',
				                            duration: duration,
		                            		allDay: false,
				                            editable: false,
				                            color: "#000000"
				                        }
								    
								    if(isEventOverlap(events_search, event_travel)){
						    			e_before_travel = getEventOverlap(events_search, event_travel)
						    			if(e_before_travel != null){
							    			gap_minute = (event.start.getTime() - e_before_travel.end.getTime()) / 60000;
							    			event_travel.start = e_before_travel.end;
							    			event_travel.end = addMinutes(event.start, duration - gap_minute);
				    						event.start = event_travel.end;
							    			event.end = addMinutes(event.end, duration - gap_minute);
							    			console.log('updating event from overlap with travel in before')
							    			$('#calendar').fullCalendar('updateEvent', event);
							    		}
						    		} 
						    		e_t_b = event_travel.id;
						    		$('#calendar').fullCalendar( 'renderEvent', event_travel, true );
							});
						}

						//second case: handle event after this
						e_after = getNextEvent(events_search, event);
						if(e_after != null){
							if(isTravelEvent(e_after)){
				    			$('#calendar').fullCalendar('removeEvents',e_after.id);
				    			e_after = getNextEventNotTravel(events_search, event);
				    			events_search = $('#calendar').fullCalendar('clientEvents',function(event_s) {
					                return event_s.start.getDate() == curdate.getDate();
					            });
				    		}
				    		if(e_after != null){
					    		from = event.title;
					    		to = e_after.title;
				    				gmaps_url = "http://maps.googleapis.com/maps/api/directions/json?origin="+encodeURIComponent(from)+",Singapore&destination="+encodeURIComponent(to)+",Singapore&sensor=false&mode=transit&departure_time="+Math.floor(new Date().getTime()/1000);
								   	
								   	$.getJSON(gmaps_url,
									  	function(data) {
										    if(data.routes.length > 0){
											    duration = Math.floor( parseInt(data.routes[0].legs[0].duration.value) / 60);
											    duration_text = data.routes[0].legs[0].duration.text;
											}else{
												duration = 30
												duration_text = "Can't get estimated time"
											}end_date_t = addMinutes(event.end, duration);
										    event_travel = {
						                            id : getTimestamp() + "_transport",
						                            title : "Travel ["+duration_text+"]. Click for details!",
						                            start : event.end,
						                            end   : end_date_t,
						                            type: 'travel',
						                            duration: duration,
			                            			allDay: false,
						                            editable: false,
						                            color: "#000000"
						                        }
										    if(isEventOverlap(events_search, event_travel)){
							    				e_after_travel = getEventOverlap(events_search, event_travel);
							    				if(e_after_travel != null){
								    				gap_minute = (e_after_travel.start.getTime() - event.end.getTime()) / 60000;
									    			event_travel.end = e_after_travel.start;
									    			event_travel.start = addMinutes(event.end, (duration - gap_minute) * -1);
									    			event.start = addMinutes(event.start, (duration - gap_minute) * -1);
									    			event.end = event_travel.start
									    			console.log('updating event from overlap with travel in after')
								    				$('#calendar').fullCalendar('updateEvent', event);

								    				/*if(e_before != null){
								    					e_b_t = $('#calendar').fullCalendar('clientEvents',function(event_s) {
											                return (event_s.start.getDate() == curdate.getDate() && event_s.id == e_t_b);
											            });
											            if(e_b_t.length != 0){
											            	console.log(e_b_t)
												            e_b_t.start = addMinutes(e_b_t.start, (duration - gap_minute) * -1);
												            e_b_t.end = event.start
											            
							    							$('#calendar').fullCalendar( 'updateEvent', e_b_t );
							    						}
								    				}*/
								    			}
								    			else 
								    				console.log('kosong euy')
								    		} 
								    		$('#calendar').fullCalendar( 'renderEvent', event_travel, true );
									});
							}
					    }
				    }

			    },
			    eventClick: function(event, element) {
			        if(event.type == 'travel'){
                		e_all = $('#calendar').fullCalendar('clientEvents',function(event_s) {
			                return event_s.start.getDate() == curdate.getDate();
			            })
			            from = getPreviousEvent(e_all, event).event_id;
			    		
                		to = getNextEvent(e_all, event).event_id;

			            directions.load("from: "+from+" to: " + to, {travelMode: G_TRAVEL_MODE_TRANSIT});
			        	$("#venue_container:visible").slideUp();
			        	$("#map_container").fadeIn("slow");
			        } else if(event.type == 'venue'){
			        	$("#map_container:visible").fadeOut();
			        	$("#venue_container").slideDown('slow');
			        }
			    },
			    eventResize: function( event, dayDelta, minuteDelta, revertFunc, jsEvent, ui, view ) { 
			    	ok=true
				    if(event.start.getHours() < 6 || event.end.getDay() != curdate.getDay()){
				    	ok=false;
				    	revertFunc();
				    } 
				    var events_search = $('#calendar').fullCalendar('clientEvents',function(event_s) {
		                return event_s.start.getDate() == curdate.getDate();
		            });
				    if(!isEventPossibleToUnOverlap(events_search, event)){
				    	console.log('not possible to unoverlap')
				    	revertFunc();
				    	ok=false;
				    }
				    if(ok){
				    	event = unOverlap(events_search, event);
					    
				    }
			    }
			});

			//initially, previous day button is disabled
			$("#calendar .fc-button-prev").addClass("ui-state-disabled");

		  	$("#calendar .fc-button-prev").click(function() {
				console.log(curdate.getTime() + ' <= ' +  TODAY.getTime())
				if(!$("#calendar .fc-button-prev").hasClass("ui-state-disabled")){
			  		curdate.setDate(curdate.getDate() - 1);
			  		if(curdate.getTime() <= TODAY.getTime())
						$("#calendar .fc-button-prev").addClass("ui-state-disabled");
				}
			});
			$("#calendar .fc-button-next").click(function() {
			  	console.log(curdate.getTime() + ' > ' +  TODAY.getTime())
				if(!$("#calendar .fc-button-next").hasClass("ui-state-disabled")){
				  	curdate.setDate(curdate.getDate() + 1);
				  	if($("#calendar .fc-button-prev").hasClass("ui-state-disabled") && curdate.getTime() > TODAY.getTime())
						$("#calendar .fc-button-prev").removeClass("ui-state-disabled");
				}
			});


			var $container = $('#catalog');
			$container.isotope({
			  	// options...
			  	animationEngine:'best-available'
			});

			// filter items when filter link is clicked
			$('#options a').click(function(){
				// don't proceed if already selected
		        if ( $(this).hasClass('selected') ) {
		          	return false;
		        }
		        var $optionSet = $(this).parents('.option-set');
		        $optionSet.find('.selected').removeClass('selected');
		        $(this).addClass('selected');

			  	var selector = $(this).attr('data-filter');
			  	$container.isotope({ filter: selector });
			  	return false;
			});
		});
    </script>

</head>
<body>
<div id="cover">
	<img src="http://plnnr.com/static/images/applanding/browse_days.png" id="browse_days_tip" />
    <img src="http://plnnr.com/static/images/applanding/schedule.png" id="schedule_tip" />
    <img src="http://plnnr.com/static/images/applanding/routes.png" id="daily_routes_tip" />
    <img src="http://plnnr.com/static/images/applanding/refine.png" id="refine_tools_tip" />
    <img src="http://plnnr.com/static/images/applanding/start_plnnring.png" id="start_plnnring_button" />
</div>

<div id="header_top">
	<div class="container">
			<h1>
				<a href="index.html" title="Dilasag"><img src="../Content/images/logo.gif" alt="getourguide" /></a></h1>
			<ul class="menu fr">
			  <li class="active"><a href="index.html" title="Home">Home</a></li>
				<li><a href="guide_registration.html" title="Be a Guide">Be a Guide</a></li>
				<li><a href="gallery.html" title="Gallery">Gallery</a></li>
				<li><a href="blog.html" title="Blog">Blog</a></li>
				<li><a href="contact-us.html" title="Contact Us">Contact Us</a></li>
			</ul>
	</div>
</div><!-- // end #header -->


<div class="advsearch leftmenu">
	<div class="colleft">
		<div class="result_container">
			<div id="map_container">
        		<div id="map" style="width:670px;height:550px;margin-right:10px;float:left;"></div>
        		<div id="panel" style="width:310px; height:550px;float:left;"></div>
    
		    </div>
		    <div id="venue_container">
		    	<div class="venue_title">Orchard</div>
		    	<section id="options" class="clearfix">
			    <ul class="option-set clearfix">
			      	<li><a href="#" data-filter="*" class="selected" >General Info</a></li>
			      	<li><a href="#" data-filter=".historical">Nearby Food</a></li>
			      	<li><a href="#" data-filter=".shopping">Nearby Praying House</a></li>
			    </ul>
			    <div id="venue_detail">
			    	<p>
			    	See exotic and endangered animals up close in their natural habitats in the Singapore Zoo. Voted the best attraction in Singapore on Trip Advisor, and considered one of the best zoos in the world, this attraction is a must see, housing over 2500 mammals, birds and reptiles.</p>

<p>Have a memorable Wild Breakfast with the Oriental small-clawed otter, reticulated python or the well-loved orang-utans (S$15.80 for adults and S$11.50 for children). Watch as the orang-utans swing effortlessly from one hold to another in their free-ranging areas. Get a better look at these primates at the boardwalk or take a picture with these apes during their feeding sessions at the Island free-ranging area at 11.30 am and 3.30 pm, or the Boardwalk free-ranging area at 2.15 pm and 4.30 pm respectively.</p>

<p>Hop aboard the Elephant Rides for an unforgettable and thrilling ride, or provide the children with bragging rights as they climb aboard the Pony Rides. Other ways to tour the park include the Horse-carriage, boat rides, or the tram, for a quicker and more efficient way to see the park in its entirety.</p>

<p>Other highlights of the zoo include the Fragile Forest, a rainforest ecosystem, and the Bat Exhibit with bats that have a wingspan of 1.7 m. Catch a glimpse of flying squirrels in the Giant Flying Squirrel Exhibit and watch squirrels soar 400 m above the ground.</p>

<p>Visit the animals in their natural habitats. Check out the Elephants of Asia, a one-hectare exhibit featuring the animal and its various historical and cultural associations. This exhibit, designed for the overall comfort of the elephants, has a mud wallow, viewing loft, bathing pool and has several thatched huts inspired by Myanmar's architecture. Walk through the eco-habitat on the elevated boardwalks to observe the elephants' behaviour and check out the amazing views of the reservoir. Educate yourself about elephants and their role in non-destructive logging operations in rainforests.</p>

<p>Animals from all over the world can be found in the Singapore Zoo. Meet the inhabitants of Australia, Africa, and even the Arctic Circle. You can visit the Australian outback to see grey kangaroos and wallabies wandering about freely and even feed them during their feeding sessions at 11 am and 4 pm. Check out the rustic sheds nearby, featuring a range of reptiles native to Australia. Be sure to look out for the more exotic reptiles such as the frill-necked lizard, the bearded dragon and the carpet python. If you're lucky enough, you might even be able to catch the notoriously shy sugar gliders. Another must-see is the cassowary with its signature vibrant and intimidating helmet.</p>

<p>Be sure to also visit the magnificent African lions in their enclosures. If you want a more personal encounter with the lions, you could actually choose to participate in the Lunch with Lions event, an event that won the Bronze Award for innovation in the International Festivals and Events Association's Pinnacle Awards in 2000. Embark on the adventure, arranged exclusively for only 15 to 21 guests, by boarding the tram which will take you into the heart of Wild Africa and to the Tropical Crops Plantation, providing you with stunning views of the tranquil Seletar Reservoir. Sip on a welcome cocktail before being ushered into the lion viewing gallery, where you will dine alongside the lions. Feast on a sumptuous buffet spread with amazing variety of cold and hot foods, appetizers, vegetables and eventually dessert, accompanied by unparalleled views of the majestic lions.</p>

Admission Rates:
<p>Should you visit on your birthday, you would be eligible for free entry if you show a form of identification and will also be eligible to enjoy other benefits.</p>

Adult – S$20.00
Child (3 to 12 years old) – S$13.00
Child (Below 3 years old) – Free
Senior Citizens (Singaporeans and Permanent Residents aged 60 & above) – S$10

<p>'Park Hopper' special packages for the Singapore Zoo, Night Safari and Jurong Bird Park are also available, where visits to the three parks need not be in one day.</p>

<p>You may also wish to purchase the 'Zoo-per Saver' special package for unlimited boat and tram rides, including the zoo's admission fee.</p>

<p>Renowned for its 'open zoo' concept and featuring 2,500 specimens from 315 species of animals, the Singapore Zoo is a must-see on any visitors' itinerary.</p>
			    </div>
			</section> <!-- #options -->
		    </div>
		    <div id="city">Singapore</div>
    	    <section id="options" class="clearfix">
			    <ul id="sort-by" class="option-set clearfix" data-option-key="sortBy">
			      	<li><a href="#" data-filter="*" class="selected" >Show all</a></li>
			      	<li><a href="#" data-filter=".historical">Historical</a></li>
			      	<li><a href="#" data-filter=".shopping">Shopping</a></li>
			      	<li><a href="#" data-filter=".modern">Modern</a></li>
			    </ul>

			</section> <!-- #options -->

            <div id="catalog">
                
            	<div id="venue" class="live-tile magenta shopping" data-delay="-1" data-initdelay="-1" event_id="238863" activity_duration="90" title="Orchard Road">
                    <span class="tile-title">Orchard Road</span>
                    <div><img class="full" src="../Content/images/photo/habibi.jpg"/></div>
                    <div>
                        <p class="full">I like to do travelling to the village and enjoy the best from nature.</p>
                    </div>
                </div>
                <div id="venue" class="live-tile blue historical" data-delay="-1" data-initdelay="-1" data-mode="flip" event_id="619795" activity_duration="210" title="Chinese Garden">    
                    <span class="tile-title">Chinese Garden</span>
                    <div><img class="full" src="../Content/images/photo/budi.jpg"/></div>
                    <div>
                        <p class="full">Enjoy a rare traditional Malay culinary while having a nice backpacking time.</p>
                    </div>
                </div>
                <div id="venue" class="live-tile red shopping" data-delay="-1" data-initdelay="-1" data-mode="flip" event_id="168732" activity_duration="90" title="Tiong Bahru Plaza">    
                    <span class="tile-title">Tiong Bahru Plaza</span>
                    <div><img class="full" src="../Content/images/photo/budi.jpg"/></div>
                    <div>
                        <p class="full">Enjoy a rare traditional Malay culinary while having a nice backpacking time.</p>
                    </div>
                </div>
                    
                <div id="venue" class="live-tile teal modern" data-delay="-1" data-initdelay="-1" data-mode="flip" event_id="018956" activity_duration="120" title="Marina Bay Sands">    
                    <span class="tile-title">Marina Bay Sands</span>
                    <div><img class="full" src="../Content/images/photo/budi.jpg"/></div>
                    <div>
                        <p class="full">Enjoy a rare traditional Malay culinary while having a nice backpacking time.</p>
                    </div>
                </div>
                <div id="venue" class="live-tile brown modern" data-delay="-1" data-initdelay="-1" data-mode="flip" event_id="098588" activity_duration="90" title="Sentosa Island">    
                    <span class="tile-title">Sentosa Island</span>
                    <div><img class="full" src="../Content/images/photo/budi.jpg"/></div>
                    <div>
                        <p class="full">Enjoy a rare traditional Malay culinary while having a nice backpacking time.</p>
                    </div>
                </div>
                <div id="venue" class="live-tile mango modern" data-delay="-1" data-initdelay="" data-mode="flip" event_id="049835" activity_duration="300" title="Boat Quay">    
                    <span class="tile-title">Boat Quay</span>
                    <div><img class="full" src="../Content/images/photo/budi.jpg"/></div>
                    <div>
                        <p class="full">Enjoy a rare traditional Malay culinary while having a nice backpacking time.</p>
                    </div>
                </div>

                <div id="venue" class="live-tile green historical" data-delay="-1" data-initdelay="-1" data-mode="flip" event_id="049178" activity_duration="60" title="Fullerton Hotel">    
                    <span class="tile-title">Fullerton Hotel</span>
                    <div><img class="full" src="../Content/images/photo/budi.jpg"/></div>
                    <div>
                        <p class="full">Enjoy a rare traditional Malay culinary while having a nice backpacking time.</p>
                    </div>
                </div>
                <div id="venue" class="live-tile blue modern" data-delay="-1" data-initdelay="-1" data-mode="flip" event_id="098585" activity_duration="150" title="Vivo City">    
                    <span class="tile-title">Vivo City</span>
                    <div><img class="full" src="../Content/images/photo/budi.jpg"/></div>
                    <div>
                        <p class="full">Enjoy a rare traditional Malay culinary while having a nice backpacking time.</p>
                    </div>
                </div>
                <div id="venue" class="live-tile lime modern" data-delay="-1" data-initdelay="-1" data-mode="flip" event_id="059815" activity_duration="150" title="Clarke Quay">    
                    <span class="tile-title">Clarke Quay</span>
                    <div><img class="full" src="../Content/images/photo/budi.jpg"/></div>
                    <div>
                        <p class="full">Enjoy a rare traditional Malay culinary while having a nice backpacking time.</p>
                    </div>
                </div>
            </div>

		</div>
		<div class="col2">
			<!-- Column 2 start -->
            <!-- Todo: Put tabbed container here. for multiple days itinerary -->
            <div id='calendar'></div>
			
			<!-- Column 2 end -->
		</div>
	</div>
</div>



<div id="footer">
	<div class="container">
		<ul class="menu fl">
			<li><img src="../Content/images/twitter.png" title="Post to twitter"/></li>
			<li><img src="../Content/images/facebook.png" title="Post to Facebook"/></li>
			<li><img src="../Content/images/google.png" title="Post to Google+"/></li>
			<li><a href="contact-us.html" title="Contact Us">Contact Us</a></li>
		</ul>
		<p>&copy; Treshno Tech, Pte. Ltd. 2013</p>
	</div>
</div><!-- // end #fppter -->
</body>
</html>